---
title: "INTERACTIVE EFFECTS OF MULTIPLE STRESSORS ACROSS BULL KELP’S (NEREOCYSTIS LUETKEANA, PHAEOPHYCEAE) LIFE-HISTORY"
subtitle: "Assessing microscopic sporophyte percent cover, density, and size"
author: "Shirah Strock"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    number_section: false
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    collapsed: true
    number_section: false
    theme: united
---

# Assessing Microscopic Sporophyte Percent Cover

## Models

```{r}
#visualize raw data distribution
hist(micro_sporos$sporophyte_percent_cover)

#GLMM
msporo_pc_lm<-glmmTMB(sporophyte_percent_cover ~ salinity_treat * temp_treat +
                           (1|days_post_release) + (1|replicate_num),
                       dispformula = ~ salinity_treat * temp_treat,
                      ziformula = ~ 1,
                       data = micro_sporos,
                      family = tweedie(link= "log"))
summary(msporo_pc_lm)


#check model assumptions using DHARMa
sim_res <- simulateResiduals(fittedModel = msporo_pc_lm, 
                             plot = TRUE)


# Test for over/underdispersion
testDispersion(sim_res)

# Test for outliers
testOutliers(sim_res)

# Test for zero-inflation 
testZeroInflation(sim_res)

plotResiduals(sim_res, form = micro_sporos$salinity_treat)
plotResiduals(sim_res, form = micro_sporos$temp_treat)
```

## Calculating estimated marginal means 

```{r}
#calculate estimated marginal means beased on tweedie model
emms1 <- emmeans(msporo_pc_lm, ~ salinity_treat * temp_treat, 
                type = "response") 

emms1_df <- as.data.frame(emms1)
emms1_df

# Pairwise comparisons with Tukey adjustment
pairwise_emms1 <- contrast(emms1, method = "pairwise", adjust = "tukey")
summary(pairwise_emms1)

# Compact letter display for grouping
cld_letterss1 <- multcomp::cld(emms1, Letters = letters, adjust = "sidak")

# Convert to dataframe and merge
emms1_df <- as.data.frame(cld_letterss1)


emms1_df

emms1_df$.group <- trimws(emms1_df$.group)
```

## Visualizations

```{r}
#micro sporo percent cover by treatment 
mspc_emm<-ggplot(emms1_df, aes(x = salinity_treat, y = response, 
                    fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkgrey", "inc" = "#505050"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = "Sporophyte Percent Cover",
       fill = "Temperature\nTreatment",
       title = NULL) +
  geom_text(aes(label = .group, y = asymp.UCL + 0.5, x = salinity_treat), 
            color = "black", position = position_dodge(0.95))+
  my_theme
mspc_emm  


#plot with line showing additive relationship (Crain et al. 2008)
mspc_emm2<-ggplot(emms1_df, aes(x = salinity_treat, y = response, 
                               fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkolivegreen1", "inc" = "darkolivegreen"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = "Sporophyte Percent Cover",
       fill = "Temperature\nTreatment",
       title = NULL) +
  geom_text(aes(label = .group, y = asymp.UCL + 0.5, x = salinity_treat), 
            color = "black", position = position_dodge(0.95))+
  geom_segment(aes(x = 2, xend = 2.55, y = 0),
               linetype = "dashed",
               color = "black",
               linewidth = 1) +
  my_theme
mspc_emm2
```

# Assessing Microscopic Sporophyte Density

## Models

```{r}
#view raw data distribution 
hist(micro_sporos$sporophyte_density)

#GLMM
msporo_den_lm<-glmmTMB(sporophyte_density ~ salinity_treat * temp_treat +
                        (1|days_post_release) + (1|replicate_num),
                      data = micro_sporos,
                      dispformula = ~ salinity_treat * temp_treat,
                      family = tweedie(link = "log"))
summary(msporo_den_lm)


#assess model fit using DHARMa
sim_ressden <- simulateResiduals(fittedModel = msporo_den_lm, 
                             plot = TRUE)


# Test for over/underdispersion
testDispersion(sim_ressden)

# Test for outliers
testOutliers(sim_ressden)

# Test for zero-inflation
testZeroInflation(sim_ressden)

plotResiduals(sim_ressden, form = micro_sporos$salinity_treat)
plotResiduals(sim_ressden, form = micro_sporos$temp_treat)


```

## Calculating estimated marginal means

```{r}
#calculate estimated marginal means based on tweedie model
emmsden <- emmeans(msporo_den_lm, ~ salinity_treat * temp_treat, 
                type = "response") 
emmsden

emmsden_df <- as.data.frame(emmsden)

# Pairwise comparisons with Tukey adjustment
pairwise_emmsden <- contrast(emmsden, method = "pairwise", adjust = "tukey")
summary(pairwise_emmsden)

# Generate CLD letters
cld_letterssden <- multcomp::cld(emmsden, Letters = letters, adjust = "sidak")

# Convert to dataframe
emmsden_df <- as.data.frame(cld_letterssden)

# Copy the actual column into a new "Letters" column directly
emmsden_df$Letters <- emmsden_df[[".group"]]
emmsden_df

#removing space in compact letter display
emmsden_df$.group <- trimws(emmsden_df$.group)
emmsden_df$Letters <- trimws(emmsden_df$Letters)
```

## Visualizations 

```{r}
#plot for microscopic sporophyte density by treatment 
msden_emm<-ggplot(emmsden_df, aes(x = salinity_treat, y = response, 
                    fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  geom_text(aes(label = Letters, y = asymp.UCL + 200),
            color = "black",position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkgrey", "inc" = "#505050"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = expression("Sporophyte Density (sporos·mm"^-2*")"),
       fill = "Temperature\nTreatment",
       title = NULL) +
  my_theme
msden_emm


#plot with line showing additive response (Crain et al. 2008)
msden_emm2<-ggplot(emmsden_df, aes(x = salinity_treat, y = response, 
                                  fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  geom_text(aes(label = Letters, y = asymp.UCL + 200),
            color = "black",position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkolivegreen1", "inc" = "darkolivegreen"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = expression("Sporophyte Density (sporos·mm"^-2*")"),
       fill = "Temperature\nTreatment",
       title = NULL) +
  geom_segment(aes(x = 2, xend = 2.55, y = 1363.3621),
               linetype = "dashed",
               color = "black",
               linewidth = 1) +
  my_theme
msden_emm2
```

# Assessing Microscopic Sporophyte Size

## Model

```{r}
#view raw data distribution
hist(micro_sporos$sporophyte_size_um2)

#tweedie model (determined by authors to be best fit for data)
msporo_size_lm<- glmmTMB(sporophyte_size_um2 ~ salinity_treat * temp_treat +
                          (1|days_post_release) + (1|replicate_num),
                         dispformula = ~ salinity_treat * temp_treat,
                         data = micro_sporos,
                         family = tweedie(link = "log"))
summary(msporo_size_lm)

#check model assumptiosn using DHARMa
sim_res3 <- simulateResiduals(fittedModel = msporo_size_lm, plot = TRUE)


# Test for over/underdispersion
testDispersion(sim_res3)

# Test for outliers
testOutliers(sim_res3)

# Test for zero-inflation
testZeroInflation(sim_res3)

plotResiduals(sim_res3, form = micro_sporos$salinity_treat)
plotResiduals(sim_res3, form = micro_sporos$temp_treat)
```

## Calculating estimated marginal means

```{r}
#calculate estimated marginal means 
emm3 <- emmeans(msporo_size_lm, ~ salinity_treat * temp_treat, 
                type = "response") 

emm3_df <- as.data.frame(emm3)

#pairwise comparisionts with Tukey
pairwise_emm3 <- contrast(emm3, method = "pairwise", adjust = "tukey")
summary(pairwise_emm3)

#Generate CLD letters 
cld_letters3 <- multcomp::cld(emm3, Letters = letters, adjust = "sidak")

#convert to data frame
emm3_df <- as.data.frame(cld_letters3)

#copy the actual colum into a new "Letters" column
emm3_df$Letters <- emm3_df[[".group"]]

#removing spaces from the compact letter display
emm3_df$.group <- trimws(emm3_df$.group)
emm3_df$Letters <- trimws(emm3_df$Letters)

emm3_df
```

## Visualizations

```{r}
#plot of emms for microscopic sporophyte size for each treatment 
mssiz_emm<- ggplot(emm3_df, aes(x = salinity_treat, y = response, 
                    fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  geom_text(aes(label = Letters, y = asymp.UCL + 5), color = "black",
            position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkgrey", "inc" = "#505050"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = "Predicted Sporophyte Size (μm2)",
       fill = "Temperature\nTreatment",
       title = NULL) +
  ylab(bquote("Sporophyte Size   "(μm^2)))+
  my_theme
mssiz_emm



#plot with line showing additive relationship (Crain et al. 2008)
mssiz_emm2<- ggplot(emm3_df, aes(x = salinity_treat, y = response, 
                                fill = temp_treat)) +
  geom_bar(stat = "identity", position = position_dodge(0.95)) +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL),
                width = 0.1, position = position_dodge(0.95)) +
  geom_text(aes(label = Letters, y = asymp.UCL + 5), color = "black",
            position = position_dodge(0.95)) +
  scale_fill_manual(
    values = c("amb" = "darkolivegreen1", "inc" = "darkolivegreen"),
    labels = c("amb" = "Ambient", "inc" = "Increased")) +
  scale_x_discrete(labels = c("amb" = "Ambient", "dec" = "Decreased")) +
  labs(x = "Salinity Treatment", 
       y = "Predicted Sporophyte Size (μm2)",
       fill = "Temperature\nTreatment",
       title = NULL) +
  ylab(bquote("Sporophyte Size   "(μm^2)))+
  geom_segment(aes(x = 2, xend = 2.55, y = 0),
               linetype = "dashed",
               color = "black", 
               linewidth = 1) +
  my_theme
mssiz_emm2
```

# Combining All Microscopic Sporophyte Plots 

```{r}
# 1. Extract the legend from one of the plots
msemm_legend <- get_legend(
  mspc_emm + theme(legend.position = "right"))

# 2. Remove the legends from the three individual plots
p1_msemm <- mspc_emm + theme(legend.position = "none",
                                 axis.title.y = element_text(size = 11))
p2_msemm <- msden_emm + theme(legend.position = "none",
                                  axis.title.y = element_text(size = 10))
p3_msemm <- mssiz_emm + theme(legend.position = "none",
                                   axis.title.y = element_text(size = 11))


top_row_msemm <- plot_grid(p1_msemm, p2_msemm, labels = c("A", "B"), ncol = 2)
bottom_row_msemm <- plot_grid(p3_msemm, msemm_legend, labels = "C", 
                             label_x = 0, rel_widths = c(1, 1))


msemm_plot <- plot_grid(top_row_msemm,
                       bottom_row_msemm,
                       ncol = 1,
                       rel_heights = c(1, 1))
msemm_plot

#saving the figure to the figure_outputs folder 
ggsave("figure4.jpg", plot = msemm_plot, width = 6, height = 7, 
       dpi = 300, units = "in",
       path = 'figure_outputs')

#save as pdf
ggsave("Figure_4.pdf", plot = msemm_plot, width = 6, height = 7, 
       dpi = 600, units = "in",
       path = 'figure_outputs')




#micro sporo combined plot with additive lines####
# 1. Extract the legend from one of the plots
msemm_legend2 <- get_legend(
  mspc_emm2 + theme(legend.position = "right"))

# 2. Remove the legends from the three individual plots
p1_msemm2 <- mspc_emm2 + theme(legend.position = "none",
                             axis.title.y = element_text(size = 11))
p2_msemm2 <- msden_emm2 + theme(legend.position = "none",
                              axis.title.y = element_text(size = 10))
p3_msemm2 <- mssiz_emm2 + theme(legend.position = "none",
                              axis.title.y = element_text(size = 11))


top_row_msemm2 <- plot_grid(p1_msemm2, p2_msemm2, labels = c("A", "B"), ncol = 2)
bottom_row_msemm2 <- plot_grid(p3_msemm2, msemm_legend2, labels = "C", 
                              label_x = 0, rel_widths = c(1, 1))


msemm_plot2 <- plot_grid(top_row_msemm2,
                        bottom_row_msemm2,
                        ncol = 1,
                        rel_heights = c(1, 1))
msemm_plot2




#one coloumn
msemm_plot2_1col <- plot_grid(p1_msemm2, p2_msemm2, p3_msemm2,
                              ncol = 1,
                              rel_heights = 1)
msemm_plot2_1col

ggsave("msporo_emm2_1col.jpg", plot = msemm_plot2_1col, width = 4, 
       height = 10, dpi = 300, units = "in",
       path = 'figure_outputs')
```
